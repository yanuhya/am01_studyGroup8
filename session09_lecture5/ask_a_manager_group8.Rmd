```{r}
library(googlesheets4)
library(tidyverse)
library(janitor) 
library(skimr)
library(countrycode) # to clean up country names
library(broom)
library(car)
library(ggfortify)
library(quantmod)
```


# Clean data

Load the ask a manager data set

```{r}
ask_a_manager_2021 <- read_csv(here::here("data", "ask_a_manager_2021.csv"))
```
Skim the data set to see if there are any missing or duplicate values

```{r}
skimr::skim(ask_a_manager_2021)
```

We see that the complete rate of "other_monetary_comp" and "currency_other" is 0. Hence, we can get rid of these columns.

```{r}
ask_a_manager_2021 <- ask_a_manager_2021 %>%
  select( -other_monetary_comp, - currency_other)
```

Let us also filter out the data where industry, highest level of educatin, gender and race is NA

```{r}
ask_a_manager_2021 <- ask_a_manager_2021 %>%
  filter(!is.na(industry) & !is.na(highest_level_of_education_completed) & !is.na(gender) & !is.na(race))
```

## Country

Now, the only columns where we have missing data is additional_context_on_job_title, additional_context_on_income, state and city

```{r warning=FALSE, message=FALSE}
unique_country_values <- unique(ask_a_manager_2021$country) %>%
  as_tibble()

unique_country_values$country_code = NA


for(i in 1:nrow(unique_country_values)){
  countryToTidy = unique_country_values$value[i]
  unique_country_values$country_code[i] = countrycode(countryToTidy, origin = 'country.name', destination = 'iso3c')
}

```

Then, find misspelled countries that has frequency higher 5 and clean the data.

```{r}
misspelled_countries <- ask_a_manager_2021[!(ask_a_manager_2021$country %in% (unique_country_values %>%
                                                      na.omit() %>%
                                                      select(value) %>% 
                                                      pull())),]

country_list <- misspelled_countries %>%
  count(country, sort=TRUE) %>%
  filter(n >= 5) %>%
  select(country) %>% 
  pull()

misspelled_countries <- misspelled_countries[misspelled_countries$country %in% country_list,]

misspelled_countries <- misspelled_countries %>%
  select(country) %>%
  unique() %>%
  mutate(country_code = ifelse(country == "Scotland" |
                                 country == "England", "GBR", ifelse(country == "NZ", "NZL", "USA"
                                 ))) %>%
  rbind((unique_country_values %>% na.omit() %>% rename(country = value)))

ask_a_manager_2021 <- ask_a_manager_2021 %>%
  left_join(misspelled_countries, by="country") %>%
  drop_na(country_code)
```

## Currency

```{r dealing with currenies}
from <- c("USD", "GBP", "CAD", "EUR", "AUD", "CHF", "ZAR", "SEK", "HKD", "JPY")
to <- "USD"
currency_rate <- rownames_to_column(getQuote(paste0(from, to, "=X")), "currency")[,c(1,3)] %>%
  mutate(currency = str_replace(currency, "USD=X", ""))
currency_rate[currency_rate$currency == "AUD","currency"] <- "AUD/NZD"

ask_a_manager_2021 <- left_join(ask_a_manager_2021, currency_rate, by="currency") %>%
  mutate(USD_salary = annual_salary * Last)

# We have 121 observations that has unsure currency, to let it not mess with our income variable (important variable), we decide to remove them entire.
ask_a_manager_2021 <- ask_a_manager_2021[!(is.na(ask_a_manager_2021$USD_salary)),]
```

## Race

```{r}
race_list <- ask_a_manager_2021 %>%
  count(race, sort=TRUE) %>% 
  filter(n >= 100) %>% 
  select(race) %>% 
  pull()

ask_a_manager_2021_race <- ask_a_manager_2021[ask_a_manager_2021$race %in% race_list,]
```

## Industry

```{r}
industry_list <- ask_a_manager_2021 %>%
  count(industry, sort=TRUE) %>% 
  filter(n >= 100) %>% 
  select(industry) %>% 
  pull()

ask_a_manager_2021_industry <- ask_a_manager_2021[ask_a_manager_2021$industry %in% industry_list,]
```

